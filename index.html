<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XRPMan XRPL NFT MEDIA PLAYER V9.55</title>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css"></script>
    <style>
        /* XRP MAN THEME - NEON LIME & VOID BLACK */
        :root {
            --bg: #000000;
            --neon: #39ff14; /* THE XRPMan Lime */
            --neon-dim: rgba(57, 255, 20, 0.2);
            --glass: rgba(10, 10, 10, 0.90);
            --border: #333;
            /* Custom Colors for Visualizer */
            --color-lime: #39ff14;
            --color-blue: #00e0ff;
            --color-red: #ff004c;
            --color-purple: #c400ff;
        }
        body {
            background-color: var(--bg);
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            overflow-x: hidden;
            margin: 0;
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }

        /* --- HEADER ANIMATIONS --- */
        @keyframes neonFire {
            0%, 100% { text-shadow: 0 0 4px #fff, 0 0 10px var(--neon), 0 0 20px var(--neon), 0 0 30px var(--neon); }
            25% { text-shadow: 0 0 2px #fff, 0 0 8px var(--neon), 0 0 15px var(--neon), 0 0 25px var(--neon); }
            50% { text-shadow: 0 0 5px #fff, 0 0 12px var(--neon), 0 0 22px var(--neon), 0 0 35px var(--neon); }
            75% { text-shadow: 0 0 3px #fff, 0 0 9px var(--neon), 0 0 18px var(--neon), 0 0 28px var(--neon); }
        }
        
        @keyframes pulseGlow {
            0% { text-shadow: 0 0 4px var(--neon), 0 0 8px var(--neon-dim); opacity: 0.9; }
            50% { text-shadow: 0 0 10px var(--neon), 0 0 20px var(--neon); opacity: 1.0; }
            100% { text-shadow: 0 0 4px var(--neon), 0 0 8px var(--neon-dim); opacity: 0.9; }
        }

        .live-border { border-bottom: 2px solid #333; }
        
        .flashing-text {
            color: var(--neon);
            text-shadow: 0 0 5px var(--neon-dim);
        }

        .neon-fire-text {
            animation: neonFire 1.5s infinite alternate;
            color: #fff;
            position: relative;
            z-index: 10;
        }

        /* MATRIX BACKGROUND CANVAS (ENHANCED BRIGHTNESS) */
        #matrixCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0.6; 
            pointer-events: none;
        }

        /* SCREENSAVER CANVAS */
        #screensaverCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000; 
            display: none; 
            background-color: var(--bg);
            cursor: pointer;
        }

        /* VISUALIZATION CONTAINER */
        .vis-container {
            border: 1px solid var(--neon);
            margin-bottom: 0px; 
            position: relative;
            overflow: visible; 
            background: rgba(0, 0, 0, 0.8);
            border-bottom: none; 
        }
        #visCanvas {
            width: 100%;
            height: 100px; 
            display: block;
            margin-top: 5px; 
        }

        /* --- VISUALIZER SETTINGS --- */
        #visGearBtn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: var(--neon);
            border: 1px solid var(--neon);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 30;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 0 5px var(--neon-dim);
            padding: 0;
        }
        #visGearBtn:hover {
            background: var(--neon);
            color: black;
            box-shadow: 0 0 10px var(--neon);
            transform: rotate(90deg);
        }
        
        #visSettingsPopup {
            position: absolute;
            top: 38px;
            right: 8px;
            width: 140px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--neon);
            box-shadow: 0 0 15px var(--neon-dim);
            padding: 10px;
            z-index: 29;
            display: none;
            flex-direction: column;
            gap: 8px;
            border-radius: 4px;
        }
        #visSettingsPopup.show { display: flex; }
        
        .vis-setting-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .vis-setting-label {
            font-size: 9px;
            color: #888;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .vis-select {
            background: black;
            color: var(--neon);
            border: 1px solid #333;
            font-size: 10px;
            padding: 4px;
            width: 100%;
            outline: none;
            cursor: pointer;
            margin-bottom: 0;
            min-height: auto;
        }
        .vis-select:hover { border-color: var(--neon); }
        
        .content-layer {
            position: relative;
            z-index: 10;
            padding: 20px;
        }
        
        /* HUD Card Style (Base Grid) */
        .card {
            background: var(--glass);
            border: 1px solid var(--neon);
            padding: 0; 
            margin-bottom: 20px;
            box-shadow: 0 0 15px var(--neon-dim);
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .card.active-track {
            border: 2px solid #fff;
            box-shadow: 0 0 25px var(--neon);
            transform: scale(1.02);
            z-index: 20;
        }
        .card-content { padding: 12px; }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--neon);
            box-shadow: 0 0 10px var(--neon);
            z-index: 10;
        }
        .card.hidden-card { display: none !important; }

        /* LIST VIEW STYLES (Overrides) */
        .list-mode-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
        }
        
        .list-mode-grid .card {
            flex-direction: row;
            align-items: center;
            height: 120px;
            margin-bottom: 5px;
        }
        
        .list-mode-grid .thumb {
            width: 120px;
            height: 100%;
            border-bottom: none;
            border-right: 1px solid var(--neon);
        }
        
        .list-mode-grid .video-container {
            width: 160px; /* Video needs slightly more width */
            height: 100%;
            border-bottom: none;
            border-right: 1px solid var(--neon);
        }
        
        .list-mode-grid .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 20px;
        }
        
        /* Adjust favorite button pos in List Mode */
        .list-mode-grid .fav-btn {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .list-mode-grid .video-container .fav-btn {
            display: none; 
        }

        /* FAVORITE BUTTON STYLE */
        .fav-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 25;
            color: #444;
            font-size: 14px;
            transition: all 0.2s;
        }
        .fav-btn:hover {
            transform: scale(1.1);
            border-color: var(--neon);
        }
        .fav-btn.is-favorite {
            color: var(--neon);
            border-color: var(--neon);
            box-shadow: 0 0 10px var(--neon);
            text-shadow: 0 0 5px var(--neon);
        }

        /* Thumbnail Style */
        .thumb {
            width: 100%;
            height: 140px; 
            object-fit: cover; 
            object-position: center; 
            border-bottom: 1px solid var(--neon);
            background-color: #050505;
            cursor: pointer;
        }
        .video-container {
            width: 100%;
            height: 180px;
            background: black;
            border-bottom: 1px solid var(--neon);
            position: relative;
        }
        .video-player {
            width: 100%;
            height: 100%;
        }

        /* Inputs & Buttons */
        input[type="text"], textarea, select {
            background: #000;
            border: 1px solid #333;
            color: var(--neon);
            padding: 12px;
            width: 100%;
            margin-bottom: 10px;
            font-family: inherit;
            outline: none;
            transition: 0.2s;
            resize: none;
            min-height: 50px;
        }
        input:focus, textarea:focus { border-color: var(--neon); box-shadow: 0 0 10px var(--neon); }
        
        /* CONTROL BAR STYLES */
        .control-bar {
            display: flex;
            align-items: center;
            justify-content: center; 
            background: var(--glass);
            border: 1px solid var(--neon);
            border-top: none; 
            padding: 6px 2px;
            margin-bottom: 0px; 
            gap: 2px;
            box-shadow: 0 0 15px var(--neon-dim);
            flex-wrap: nowrap; 
            overflow-x: hidden;
        }

        /* Volume Bar */
        .volume-bar {
            display: flex;
            align-items: center;
            background: #050505;
            border: 1px solid var(--neon);
            border-top: none;
            padding: 4px 12px;
            gap: 12px;
            box-shadow: 0 0 10px var(--neon-dim);
        }
        .volume-slider {
            flex-grow: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #222;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--neon);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--neon);
        }
        
        /* New Screensaver Bar */
        .saver-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0a0a0a;
            border: 1px solid #333;
            border-top: none;
            padding: 4px 8px;
            margin-bottom: 15px;
            gap: 10px;
        }

        /* Progress HUD */
        .progress-hud {
            width: 100%;
            height: 6px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 15px;
            position: relative;
            display: none;
            overflow: hidden;
        }
        .progress-hud-fill {
            height: 100%;
            width: 0%;
            background: var(--neon);
            box-shadow: 0 0 10px var(--neon);
            transition: width 0.1s linear;
        }

        button {
            background: rgba(57, 255, 20, 0.1);
            color: var(--neon);
            border: 1px solid var(--neon);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.2s;
            text-shadow: 0 0 5px var(--neon);
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        
        .icon-btn {
            padding: 0; 
            width: 32px; 
            height: 32px; 
            font-size: 14px; 
            flex-shrink: 0;
            border-radius: 4px; 
        }

        button:hover { 
            background: var(--neon); 
            color: #000; 
            box-shadow: 0 0 20px var(--neon); 
            text-shadow: none;
        }
        
        .toggle-btn.active {
            background: rgba(57, 255, 20, 0.3);
            box-shadow: 0 0 10px var(--neon-dim);
            border-color: #fff;
        }
        
        .divider {
            width: 1px;
            height: 20px;
            background: #333;
            margin: 0 1px; 
            flex-shrink: 0;
        }

        /* TABS */
        .tabs-header {
            display: flex;
            width: 100%;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        .tab-btn {
            flex: 1;
            background: black;
            color: #666;
            border: 1px solid #333;
            border-bottom: none;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active-tab {
            color: var(--neon);
            border: 1px solid var(--neon);
            border-bottom: 2px solid black;
            margin-bottom: -1px;
            background: rgba(57, 255, 20, 0.05);
            text-shadow: 0 0 5px var(--neon-dim);
        }
        .tab-content { display: none; }
        .tab-content.active-content { display: grid; }

        /* Audio Player */
        audio { 
            width: 100%; 
            margin-top: 8px; 
            height: 30px; 
            filter: invert(1) sepia(1) saturate(5) hue-rotate(80deg);
            opacity: 0.9;
        }
        
        .powered-by-text {
            color: var(--neon);
            opacity: 1;
            font-size: 14px;
            letter-spacing: 2px;
            font-weight: bold;
            animation: pulseGlow 2s infinite alternate;
        }
        
        .header-titles {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            gap: 0;
        }
        .header-titles p {
            margin: 0;
            line-height: 1.2; 
            font-size: 1rem;
            font-weight: bold;
        }
        .header-titles h1 {
            margin: 0;
            line-height: 1.2;
            font-size: 2rem;
        }
        
        .version-tag {
            color: black !important;
            background-color: var(--neon); 
            box-shadow: 0 0 10px var(--neon);
            text-shadow: none;
        }
        
        /* CURRENT TRACK DISPLAY */
        #currentTrackDisplay {
            font-size: 14px;
            color: var(--neon);
            text-align: center;
            margin-top: 5px;
            margin-bottom: 5px;
            font-weight: bold;
            min-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            padding: 0 10px;
        }
        
        /* MARQUEE ANIMATION */
        @keyframes marquee {
          0% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
        }

        .marquee {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 10s linear infinite;
            text-shadow: 0 0 5px var(--neon);
        }

        #currentMetadata {
            font-size: 10px;
            opacity: 0.8;
            color: var(--neon);
            font-weight: normal;
            text-align: center;
            margin-bottom: 5px;
            word-break: break-all;
        }

        /* LINK TREE STYLING */
        .link-footer {
            padding: 10px;
            text-align: center;
            margin-top: 20px;
        }
        .link-footer a {
            font-size: 14px;
            color: var(--neon);
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.2s;
            font-weight: bold;
            text-shadow: 0 0 5px var(--neon), 0 0 10px var(--neon-dim);
        }
        
        /* --- FLOATING EQ MODAL --- */
        #eqModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--neon);
            box-shadow: 0 0 25px var(--neon);
            padding: 15px;
            z-index: 2000;
            width: 90%;
            max-width: 450px;
            display: none;
            flex-direction: column;
        }
        #eqModal.open { display: flex; }
        .eq-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 200px;
            padding: 10px 0;
            gap: 5px;
        }
        .eq-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        .eq-column input[type="range"] {
            width: 100%;
            height: 150px;
            -webkit-appearance: none;
            writing-mode: bt-lr; 
            appearance: slider-vertical;
            background: var(--glass);
            margin: 5px 0;
            border: 1px solid var(--neon-dim);
            box-shadow: 0 0 5px var(--neon-dim) inset;
            cursor: grab;
        }
        .eq-column input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: var(--neon);
            box-shadow: 0 0 10px var(--neon);
            border-radius: 50%;
        }
        .eq-frequency { font-size: 9px; color: #999; margin-top: 5px; }
        .eq-gain { font-size: 9px; color: var(--neon); }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--neon);
            font-size: 1.5rem;
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            z-index: 10;
            text-shadow: 0 0 5px var(--neon);
            line-height: 1;
            padding: 0;
        }
    </style>
</head>
<body>

<!-- BACKGROUND CANVAS (Matrix Rain) -->
<canvas id="matrixCanvas"></canvas>

<!-- SCREENSAVER CANVAS -->
<canvas id="screensaverCanvas"></canvas>

<div class="content-layer max-w-2xl mx-auto">
    <!-- RESTORED ANIMATED HEADER (CENTERED) -->
    <div class="mb-4 live-border pb-4 flex justify-between items-end">
        <div class="header-titles">
            <p class="tracking-widest flashing-text" style="animation: none; opacity: 1; text-shadow: 0 0 2px var(--neon);">XRPMAN PRODUCTIONS PRESENTS</p>
            <h1 class="font-bold neon-fire-text tracking-wider">XRPL NFT MEDIA PLAYER</h1>
            <p class="powered-by-text">POWERED BY XMEME</p>
        </div>
        <div class="text-[10px] text-black font-bold px-2 py-1 version-tag">V9.55</div>
    </div>
    
    <!-- CURRENT TRACK DISPLAY -->
    <div id="currentTrackDisplay">
        <span id="marqueeText" class="marquee">READY TO SCAN LEDGER --- ENTER ADDRESSES BELOW</span>
    </div>
    <div id="currentMetadata"></div>

    <!-- MAIN INTERFACE -->
    <div class="mb-6">
        <!-- RESTORED INPUTS (TRUE BOX LAYOUT) -->
        <div class="mb-10">
            <div id="inputBoxWrapper" class="border border-[#333] bg-black w-full max-w-full overflow-hidden flex flex-col mb-3">
                <div class="flex justify-between items-center bg-[#0a0a0a] border-b border-[#333] px-3 py-2">
                    <label class="text-[9px] text-[#39ff14] font-bold tracking-widest">XRPL WALLET ADDRESSES</label>
                    <button onclick="app.clearWallets();" 
                            class="text-[9px] px-2 py-1 border border-[#333] text-[#666] hover:text-[#39ff14] hover:border-[#39ff14] bg-black font-bold transition-all">
                        CLEAR
                    </button>
                </div>
                <textarea id="accountInput" 
                    placeholder="r..." 
                    class="text-xs font-mono h-20 w-full bg-black text-[#39ff14] p-3 outline-none border-none resize-none focus:bg-[#050505] transition-colors"
                    style="white-space: pre-wrap; word-break: break-all;"
                    oninput="app.validateInput(this)"></textarea>
            </div>

            <!-- RESTORED SCAN BUTTON (ROUND PILL) -->
            <button onclick="app.fetch()" class="w-full h-12 bg-[#39ff14] text-black font-black rounded-full shadow-[0_0_15px_rgba(57,255,20,0.5)] hover:shadow-[0_0_25px_#39ff14] hover:scale-[1.02] transition-all tracking-widest text-sm mb-1">
                SCAN LEDGER
            </button>
            
            <div id="inputFeedback" class="text-[9px] text-[#666] text-right mt-1 h-3 pr-1 font-bold"></div>
        </div>
        
        <!-- VISUALIZATION -->
        <div class="vis-container">
            <button id="visGearBtn" onclick="visualizer.toggleSettings()" title="Vis Settings">‚öô</button>
            <div id="visSettingsPopup">
                <div class="vis-setting-row">
                    <span class="vis-setting-label">MODE</span>
                    <select class="vis-select" onchange="visualizer.setMode(this.value)">
                        <option value="wave" selected>Wave</option>
                        <option value="bars">Bars</option>
                        <option value="dualbars">Dual Bars</option>
                        <option value="circles">Neon Rings</option>
                        <option value="pixel">Matrix Grid</option>
                    </select>
                </div>
                <div class="vis-setting-row">
                    <span class="vis-setting-label">COLOR</span>
                    <select class="vis-select" onchange="visualizer.setColor(this.value)">
                        <option value="lime" selected>Lime</option>
                        <option value="blue">Blue</option>
                        <option value="red">Red</option>
                        <option value="purple">Purple</option>
                    </select>
                </div>
            </div>
            <canvas id="visCanvas"></canvas>
        </div>

        <!-- CONTROL BAR -->
        <div class="control-bar">
            <button class="icon-btn" onclick="app.playPrev()" title="Previous">‚èÆ</button>
            <button id="btnPlayPause" class="icon-btn" onclick="app.togglePlay()" title="Play/Pause">‚ñ∂</button>
            <button class="icon-btn" onclick="app.playNext()" title="Next">‚è≠</button>
            <div class="divider"></div>
            <button id="btnShuffle" class="icon-btn toggle-btn" onclick="app.toggleShuffle()" title="Shuffle">üîÄ</button>
            <button id="btnLoop" class="icon-btn toggle-btn active" onclick="app.toggleLoop()" title="Loop">üîÅ</button>
            <div class="divider"></div>
            <!-- VIEW & FAV -->
            <button id="btnView" class="icon-btn toggle-btn" onclick="app.toggleListView()" title="Toggle Grid/List">‚ò∞</button>
            <button id="btnFav" class="icon-btn toggle-btn" onclick="app.toggleFavView()" title="Filter Favorites" style="font-size: 10px;">FAV</button>
            <button id="btnEQ" class="icon-btn toggle-btn active" onclick="eqControl.toggleModal(true)" title="EQ" style="font-size: 10px;">EQ</button>
        </div>

        <!-- VOLUME BAR -->
        <div class="volume-bar">
            <span class="text-[9px] text-[#39ff14] font-black">VOL</span>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" class="volume-slider" oninput="app.setVolume(this.value)">
            <span id="volumeValue" class="text-[9px] text-[#39ff14] font-bold min-w-[24px]">100%</span>
        </div>
        
        <!-- SCREENSAVER BAR -->
        <div class="saver-bar">
            <button id="btnScreensaver" class="icon-btn" onclick="screensaverEngine.toggle()" title="Start Screensaver" style="width: 40px;">‚ñ∂Ô∏è</button>
            <div class="text-[7px] text-[#00ff00] font-bold whitespace-nowrap" style="animation: pulseGlow 2s infinite alternate;">SCREENSAVER</div>
            <select id="saverModeSelect" class="vis-select" onchange="screensaverEngine.setMode(this.value)" style="flex-grow: 1; height: 32px; border: 1px solid #333;">
                <option value="original">Original Saver</option>
                <option value="void">Void (Black)</option>
                <option value="hyperdrive">Hyperdrive</option>
                <option value="spectrum">Spectrum Tunnel</option>
                <option value="xmeme">XMEME</option>
                <option value="gallery">NFT Gallery</option>
            </select>
        </div>
    </div>

    <!-- PROGRESS HUD -->
    <div id="progressHUD" class="progress-hud">
        <div id="progressFill" class="progress-hud-fill"></div>
    </div>

    <!-- STATUS -->
    <div id="status" class="text-center text-sm font-mono text-[#39ff14] mb-6 hidden border border-[#39ff14] p-2 bg-black shadow-[0_0_10px_rgba(57,255,20,0.2)]"></div>
    
    <!-- TABS -->
    <div class="tabs-header">
        <div id="tabAudio" class="tab-btn active-tab" onclick="app.switchTab('audio')">AUDIO (0)</div>
        <div id="tabVideo" class="tab-btn" onclick="app.switchTab('video')">VIDEO (0)</div>
        <div id="tabImage" class="tab-btn" onclick="app.switchTab('image')">IMAGES (0)</div>
    </div>

    <!-- Results Grids -->
    <div id="audioResults" class="tab-content active-content grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    <div id="videoResults" class="tab-content grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    <div id="imageResults" class="tab-content grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    
    <!-- LINK FOOTER -->
    <div class="link-footer">
        <a href="https://linktr.ee/XRPMan" target="_blank">https://linktr.ee/XRPMan</a>
    </div>
</div>

<!-- EQ MODAL -->
<div id="eqModal" onclick="eqControl.handleModalClick(event)">
    <button class="modal-close-btn" onclick="eqControl.toggleModal(false)">‚úï</button>
    <h2 class="text-center text-sm text-white font-bold mb-3 tracking-widest">AUDIO EQUALIZER (GAIN dB)</h2>
    <div class="eq-controls" id="eqSliders"></div>
</div>

<script>
// --- CORE UTILS & MATRIX (UPDATED AUTHENTIC CHARS) ---
const matrix = {
    canvas: document.getElementById('matrixCanvas'),
    ctx: null,
    chars: "„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",
    drops: [],
    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        setInterval(() => this.draw(), 50);
    },
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        const columns = Math.floor(this.canvas.width / 20);
        this.drops = Array(columns).fill(1);
    },
    draw() {
        this.ctx.fillStyle = "rgba(0, 0, 0, 0.04)"; 
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.fillStyle = "#39ff14";
        this.ctx.font = "15px monospace";
        for (let i = 0; i < this.drops.length; i++) {
            const text = this.chars[Math.floor(Math.random() * this.chars.length)];
            this.ctx.fillText(text, i * 20, this.drops[i] * 20);
            if (this.drops[i] * 20 > this.canvas.height && Math.random() > 0.975) this.drops[i] = 0;
            this.drops[i]++;
        }
    }
};
matrix.init();

const wakeLockManager = {
    wakeLock: null,
    async requestLock() { if ('wakeLock' in navigator) try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} },
    releaseLock() { if (this.wakeLock) { this.wakeLock.release().then(() => this.wakeLock = null); } }
};

// --- EQ ENGINE ---
const eqControl = {
    bands: [31, 63, 125, 250, 500, 1000, 2000, 4000, 8000, 16000],
    filters: [],
    init(audioCtx) {
        if (!audioCtx) return;
        this.filters = [];
        let conn = visualizer.analyser;
        this.bands.forEach((freq, idx) => {
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'peaking'; filter.frequency.value = freq; filter.Q.value = 1.0; filter.gain.value = 0;
            conn.connect(filter); conn = filter; this.filters.push(filter);
        });
        conn.connect(audioCtx.destination);
        this.createSliders();
    },
    createSliders() {
        const container = document.getElementById('eqSliders');
        container.innerHTML = '';
        this.bands.forEach((freq, idx) => {
            const col = document.createElement('div');
            col.className = 'eq-column';
            col.innerHTML = `
                <span class="eq-gain" id="g-${idx}">0 dB</span>
                <input type="range" min="-15" max="15" value="0" step="1" orient="vertical" oninput="eqControl.update(${idx}, this.value)">
                <span class="eq-frequency">${freq >= 1000 ? freq/1000+'k' : freq}</span>
            `;
            container.appendChild(col);
        });
    },
    update(idx, val) {
        this.filters[idx].gain.value = parseFloat(val);
        document.getElementById(`g-${idx}`).textContent = val + " dB";
    },
    toggleModal(open) {
        if (open && !visualizer.audioCtx) { app.showStatus("‚ö†Ô∏è PLAY MEDIA FIRST TO ENABLE EQ", false, 3000); return; }
        document.getElementById('eqModal').classList.toggle('open', open);
    },
    handleModalClick(e) { if (e.target.id === 'eqModal') this.toggleModal(false); }
};

// --- VISUALIZER ENGINE (FIXED LOGIC) ---
const visualizer = {
    canvas: document.getElementById('visCanvas'),
    ctx: null, audioCtx: null, analyser: null, dataArray: null, mode: 'wave', color: '#39ff14',
    init() { this.ctx = this.canvas.getContext('2d'); this.resize(); window.addEventListener('resize', () => this.resize()); this.loop(); },
    resize() { const dpr = window.devicePixelRatio || 1; const r = this.canvas.getBoundingClientRect(); this.canvas.width = r.width * dpr; this.canvas.height = r.height * dpr; this.ctx.scale(dpr, dpr); },
    setMode(m) { this.mode = m; },
    setColor(c) { this.color = {lime:'#39ff14', blue:'#00e0ff', red:'#ff004c', purple:'#c400ff'}[c] || '#39ff14'; },
    toggleSettings() { document.getElementById('visSettingsPopup').classList.toggle('show'); },
    connectAudio(el) {
        if (!this.audioCtx) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioCtx.createAnalyser(); this.analyser.fftSize = 2048;
            this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            eqControl.init(this.audioCtx);
        }
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
        if (!el._connected) {
            try { const src = this.audioCtx.createMediaElementSource(el); src.connect(this.analyser); el._connected = true; } catch(e) {}
        }
    },
    draw() {
        const ctx = this.ctx; const w = this.canvas.width/devicePixelRatio; const h = this.canvas.height/devicePixelRatio;
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0,0,w,h);
        if (!this.analyser) return;
        const data = this.dataArray;
        
        // --- DRAW LOGIC ---
        if (this.mode === 'wave') {
            this.analyser.getByteTimeDomainData(data);
            ctx.beginPath(); ctx.lineWidth = 2; ctx.strokeStyle = this.color;
            const slice = w / data.length; let x = 0;
            for(let i=0; i<data.length; i++) {
                const v = data[i]/128.0; const y = v * h / 2;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                x += slice;
            }
            ctx.stroke();
        } else if (this.mode === 'bars') {
            this.analyser.getByteFrequencyData(data);
            const bars = 32; const bw = w/bars;
            for(let i=0; i<bars; i++) {
                const bh = (data[i*4]/255)*h; ctx.fillStyle = this.color; ctx.fillRect(i*bw, h-bh, bw-2, bh);
            }
        } else if (this.mode === 'dualbars') {
            this.analyser.getByteFrequencyData(data);
            const bars = 40; const bw = w/bars; const cy = h/2;
            for(let i=0; i<bars; i++) {
                const bh = (data[i*2]/255)*(h/2); 
                ctx.fillStyle = this.color; 
                ctx.fillRect(i*bw, cy-bh, bw-2, bh);
                ctx.fillStyle = this.color + "90";
                ctx.fillRect(i*bw, cy, bw-2, bh);
            }
        } else if (this.mode === 'circles') {
            this.analyser.getByteFrequencyData(data);
            let bass = 0; for(let i=0; i<10; i++) bass += data[i]; bass /= 10;
            ctx.beginPath(); ctx.arc(w/2, h/2, 20 + (bass/255)*(h/3), 0, Math.PI*2);
            ctx.strokeStyle = this.color; ctx.lineWidth = 3; ctx.stroke();
            ctx.beginPath(); ctx.arc(w/2, h/2, 10 + (data[20]/255)*(h/4), 0, Math.PI*2);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
        } else if (this.mode === 'pixel') {
            this.analyser.getByteFrequencyData(data);
            const cols = 20; const rows = 10; const cw = w/cols; const rh = h/rows;
            for(let c=0; c<cols; c++) {
                const val = Math.floor((data[c*3]/255)*rows);
                for(let r=0; r<val; r++) {
                    ctx.fillStyle = (r===val-1) ? '#fff' : this.color;
                    ctx.fillRect(c*cw+1, h-(r+1)*rh+1, cw-2, rh-2);
                }
            }
        }
    },
    loop() { this.draw(); requestAnimationFrame(() => this.loop()); }
};
visualizer.init();

// --- SCREENSAVER ENGINE (INDEPENDENT MODE) ---
const screensaverEngine = {
    canvas: document.getElementById('screensaverCanvas'),
    ctx: null, isActive: false, mode: 'original', offset: 0, rafId: null,
    stars: [], tunnelRotation: 0,
    gallery: { current: null, timer: 0, opacity: 0, nextIdx: -1, loaded: new Map() },
    xmeme: { x: 0, y: 0, vx: 3.5, vy: 3.5, baseW: 100, baseH: 100, squishX: 1, squishY: 1, shape: 'square', hitCount: 0 },
    
    init() {
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.canvas.onclick = () => this.toggle();
        for(let i=0; i<200; i++) this.stars.push({x: Math.random()*2000-1000, y: Math.random()*2000-1000, z: Math.random()*1000});
        this.xmeme.x = window.innerWidth / 2; this.xmeme.y = window.innerHeight / 2;
    },
    setMode(m) { this.mode = m; },
    toggle() {
        this.isActive = !this.isActive;
        this.canvas.style.display = this.isActive ? 'block' : 'none';
        if (this.isActive) {
            wakeLockManager.requestLock(); 
            this.gallery.timer = 0; // Reset gallery timer on start
            this.loop();
        } else { cancelAnimationFrame(this.rafId); wakeLockManager.releaseLock(); }
    },
    loop() {
        if(!this.isActive) return;
        const ctx = this.ctx; const w = this.canvas.width; const h = this.canvas.height;
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,w,h);
        
        let data;
        if (visualizer.analyser && visualizer.dataArray) {
            visualizer.analyser.getByteFrequencyData(visualizer.dataArray);
            data = visualizer.dataArray;
        } else {
            data = new Uint8Array(128).fill(0);
        }

        if (this.mode === 'original') this.drawOriginal(ctx, w, h, data);
        else if (this.mode === 'hyperdrive') this.drawHyperdrive(ctx, w, h, data);
        else if (this.mode === 'spectrum') this.drawSpectrumTunnel(ctx, w, h, data);
        else if (this.mode === 'xmeme') this.drawXmeme(ctx, w, h, data);
        else if (this.mode === 'gallery') this.drawGallery(ctx, w, h, data);

        this.rafId = requestAnimationFrame(() => this.loop());
    },
    drawOriginal(ctx, w, h, data) {
        const bw = 10; const bs = 8; const count = Math.floor(w/(bw+bs)); const step = Math.floor(data.length/count);
        this.offset += 1.5; if (this.offset > w) this.offset = 0;
        for (let i = 0; i < count; i++) {
            const val = data[i * step] || 0; const bh = (val/255)*h*0.6;
            let x = i*(bw+bs)+this.offset; if(x > w) x -= w+bw;
            const y = h - bh + (-200*(x/w));
            ctx.fillStyle = visualizer.color + "99"; ctx.fillRect(x, y, bw, bh);
        }
    },
    drawHyperdrive(ctx, w, h, data) {
        let bass = 0; for(let i=0; i<10; i++) bass += data[i]; bass /= 10;
        const speed = 2 + (bass/255)*20;
        ctx.fillStyle = '#fff';
        this.stars.forEach(s => {
            s.z -= speed; if(s.z <= 0) { s.z=1000; s.x=Math.random()*2000-1000; s.y=Math.random()*2000-1000; }
            const k = 128.0/s.z; const px = s.x*k + w/2; const py = s.y*k + h/2;
            if(px>=0 && px<=w && py>=0 && py<=h) { ctx.beginPath(); ctx.arc(px,py,(1-s.z/1000)*3,0,Math.PI*2); ctx.fill(); }
        });
    },
    drawSpectrumTunnel(ctx, w, h, data) {
        let bass = 0; for(let i=0; i<5; i++) bass += data[i]; bass /= 5;
        this.tunnelRotation += 0.005 + (bass/255)*0.05;
        for (let i = 0; i < 30; i++) {
            const prog = i/30; const val = data[Math.floor(prog*(data.length*0.3))] || 0;
            const rad = (Math.max(w,h)*0.8*prog*prog) + (val*0.5);
            ctx.strokeStyle = `hsla(${(Date.now()/20+i*15+bass*0.5)%360}, 100%, 50%, ${prog})`;
            ctx.save(); ctx.translate(w/2, h/2); ctx.rotate((this.tunnelRotation*(i%2===0?1:-1))+(i*0.1));
            ctx.beginPath(); ctx.rect(-rad/2, -rad/2, rad, rad); ctx.stroke(); ctx.restore();
        }
    },
    drawGallery(ctx, w, h, data) {
        const images = app.imageList;
        if (images.length === 0) {
            ctx.fillStyle = visualizer.color; ctx.font = "20px monospace"; ctx.textAlign = "center";
            ctx.fillText("NO NFT IMAGES FOUND IN WALLET", w/2, h/2); return;
        }

        const g = this.gallery;
        g.timer++;

        // Change image every 300 frames (~5 seconds)
        if (g.timer > 300 || !g.current) {
            g.timer = 0;
            const nextIdx = Math.floor(Math.random() * images.length);
            const nextUrl = images[nextIdx].url;
            
            if (!g.loaded.has(nextUrl)) {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = nextUrl;
                img.onload = () => g.loaded.set(nextUrl, img);
            }
            g.current = g.loaded.get(nextUrl) || g.current;
            g.opacity = 0;
        }

        if (g.current) {
            if (g.opacity < 1) g.opacity += 0.02;
            ctx.globalAlpha = g.opacity;
            const aspect = g.current.width / g.current.height;
            let dw, dh;
            if (w/h > aspect) { dh = h * 0.8; dw = dh * aspect; }
            else { dw = w * 0.8; dh = dw / aspect; }
            
            // Neon Frame
            ctx.strokeStyle = visualizer.color;
            ctx.lineWidth = 4;
            ctx.strokeRect((w-dw)/2 - 5, (h-dh)/2 - 5, dw + 10, dh + 10);
            ctx.drawImage(g.current, (w-dw)/2, (h-dh)/2, dw, dh);
   